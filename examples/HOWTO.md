# Analysis of all median ECG beats in FDA Study 1

This document describes how to run the T-wave delineator example for all median beats in [FDA Study 1](http://physionet.org/physiobank/database/ecgrdvq) files available at Physionet. 

## ANALYSIS AND REPORTS

1. *Optional:* download a copy of the database. This step will allow for faster analysis of all ECG records. If you do not have a local copy of the database, the C++ code will download one file at a time with curl when calling Physionet's wfdb library functions.
```
rsync -Cavz physionet.org::ecgrdvq ./ecgrdvq 
```
2. **Compile** tool to download physionet annotations and t-wave delineator c++ example. Please note that you need to build [ecglib](../ecglib/README.md) library first.
```
g++ -std=c++11 -o getdbannotations getdbannotations.cpp -lboost_program_options -lboost_filesystem -lboost_system -lwfdb
g++ -std=c++11 -o twavedelineatorphysionet twavedelineatorphysionet.cpp filters/butterworth/butter.cpp -lecglib-core -lecglib-delineators-twave -lboost_program_options -lboost_filesystem -lboost_system -lboost_date_time -lwfdb
```
3. Filter the RECORDS file to build an index of the median beat files
```
curl http://physionet.org/physiobank/database/ecgrdvq/RECORDS | grep medians > allmedians.csv
```
4. Download a copy of clinical data file. The bash script that call the t-wave delineator for all medians parses this file to pass the corresponding RR interval to the t-wave delineator.
```
wget http://physionet.org/physiobank/database/ecgrdvq/SCR-002.Clinical.Data.csv 
```
5. Download all annotations for all median beats in the index built in step 3 above.
```
./getdbannotations --index allmedians.csv > dbannotations.csv
```
6. Launch shell script that delineate all median beats using the files generated in the steps above.
```
./delineateall.sh dbannotations.csv > results.csv
```
7. Generate reports that include Bland Altmant plots for comparison as well as time profiles and exposure response plots similar to those presented in the J-Tpeak initiative sessions at ISCE 2017 meeting.
```
Rscript generatereport.R 
```
8. The file [ResultsExample.md](ResultsExample.md) contains a summary of the detailed results included in  the following reports generated by step 7. above:
    * Example of ECGs for which the noise present in the first derivative had effect in the location of Tpeak or Tend: FilterEffect.html 
    * Time-profiles and exposure-response models:
      - using annotations from filtered ECGs: ISCE-JTpeak-Time.and.ER-Filtered.html
      - using annotations from no-filtered ECGs:SCE-JTpeak-Time.and.ER-NO-Filtered.html
    * Bland Altman plots summarizing differences between filtered and no-filtered results vs. reference annotations:
      - Reference vs. annotations from filtered ECGs: FDAStudy1Comparison-reference-vs-algorithm-Filtered.html
      - Reference vs. annotations from no-filtered ECGs: FDAStudy1Comparison-reference-vs-algorithm-NO-Filtered.html

## LICENSE

These examples source code is in the public domain within the United States, and copyright and related rights in the work worldwide are waived through the CC0 1.0 Universal Public Domain Dedication. These examples are distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See DISCLAIMER section below, https://github.com/FDA/ecglib/, https://creativecommons.org/publicdomain/zero/1.0/ and https://www.gnu.org/licenses/gpl-faq.html for more details.
 
## DISCLAIMER

FDA assumes no responsibility whatsoever for use by other parties of the Software, its source code, documentation or compiled executables, and makes no guarantees, expressed or implied, about its quality, reliability, or any other characteristic.  Further, FDA makes no representations that the use of the Software will not infringe any patent or proprietary rights of third parties.   The use of this code in no way implies endorsement by the FDA or confers any advantage in regulatory decisions.

## REQUIREMENTS

ecglib library and examples were compiled with g++ version 4.8.4 from [GCC, the GNU Compiler Collection](https://gcc.gnu.org/). In addition to ecglib requirements (e.g.: cmake, armadillo, blas, lapack and boost for ecglib 1.0.0), you will need the following software to run these examples and scripts:

* csvtool is required by delineateall.sh script.
* To generate statistical analysis reports
  * R 3.2.3 or later
  * Check .R and .Rmd files for additional R packages required to generate the statistical analysis reports (e.g. tidyverse, lme4, lsmeans, pander, BlandAltmanLeh, ggExtra, gridExtra and dependencies)

## REFERENCES

1. Johannesen L, Vicente J, Hosseini M, Strauss DG. [Automated Algorithm for J-Tpeak and Tpeak-Tend Assessment of Drug-Induced Proarrhythmia Risk](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5201230/). PLoS One. 2016; 11(12): e0166925. doi: 10.1371/journal.pone.0166925.
2. ECG Effects of Ranolazine, Dofetilide, Verapamil, and Quinidine in Healthy Subjects. [doi:10.13026/C2HP45](http://doi.org/10.13026/C2HP45)
3. Johannesen L, Vicente J, Mason JW, Sanabria C, Waite-Labott K, Hong M, Guo P, Lin J, SÃ¸rensen JS, Galeotti L, Florian J, Ugander M, Stockbridge N, Strauss DG. [Differentiating Drug-Induced Multichannel Block on the Electrocardiogram: Randomized Study of Dofetilide, Quinidine, Ranolazine, and Verapamil](http://www.ncbi.nlm.nih.gov/pubmed/25054430). Clin Pharmacol Ther. 2014. doi: 10.1038/clpt.2014.155.
4. Vicente J, Johannesen L, Mason JW, Crumb WJ, Pueyo E, Stockbridge N, Strauss DG. [Comprehensive T wave morphology assessment in a randomized clinical study of dofetilide, quinidine, ranolazine, and verapamil](http://www.ncbi.nlm.nih.gov/pubmed/25870186).doi: 10.1161/JAHA.114.001615.
5. R Core Team (2015). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.
